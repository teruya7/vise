==========
Python API
==========

In this tutorial, we show how to use vise in the python program.

.. contents:: Table of Contents
   :local:
   :depth: 2

Quick Start with vise.api
-------------------------

The ``vise.api`` module provides a clean Python API for all vise functionality.

Structure Analysis
~~~~~~~~~~~~~~~~~~

::

    from pymatgen.core import Structure
    from vise.api import structure

    # Load a structure
    struct = Structure.from_file("POSCAR")

    # Get symmetry information
    info = structure.get_symmetry_info(struct)
    print(f"Space group: {info.space_group_symbol} ({info.space_group_number})")
    print(f"Crystal system: {info.crystal_system}")
    print(f"Point group: {info.point_group}")
    print(f"Bravais lattice: {info.bravais_lattice}")
    print(f"Volume: {info.volume:.4f} Å³")

    # Get primitive cell
    primitive = structure.get_primitive(struct)
    primitive.to(filename="POSCAR_primitive")

    # Get conventional cell
    conventional = structure.get_conventional(struct)
    conventional.to(filename="POSCAR_conventional")

VASP Input Generation
~~~~~~~~~~~~~~~~~~~~~

::

    from pymatgen.core import Structure
    from vise.api import vasp_inputs

    # Load structure
    struct = Structure.from_file("POSCAR")

    # Create VASP input set for structure optimization
    inputs = vasp_inputs.create_vasp_set(
        struct,
        task="structure_opt",  # or Task.structure_opt
        xc="pbe",              # or Xc.pbe
    )

    # Write input files to directory
    inputs.write("./relax")

    # Available tasks and XC functionals
    print("Tasks:", vasp_inputs.get_available_tasks())
    # ['structure_opt', 'band', 'dos', 'defect', ...]

    print("XC:", vasp_inputs.get_available_xc())
    # ['pbe', 'pbesol', 'hse', 'scan', ...]

    # Custom INCAR settings
    inputs = vasp_inputs.create_vasp_set(
        struct,
        task="band",
        xc="hse",
        user_incar_settings={"EDIFF": 1e-6, "NELM": 200}
    )
    inputs.write("./band")

Band Structure Analysis
~~~~~~~~~~~~~~~~~~~~~~~

::

    from vise.api import band

    # Analyze band structure from VASP output
    result = band.analyze_band("vasprun.xml", "KPOINTS")

    # Check if metallic
    if result.is_metal:
        print("System is metallic")
    else:
        print(f"Band gap: {result.band_gap:.4f} eV")
        print(f"VBM: {result.vbm:.4f} eV")
        print(f"CBM: {result.cbm:.4f} eV")

    # Save plot
    result.save_plot("band.pdf", energy_range=(-5, 5))

    # Save data as JSON
    result.save_json("band_data.json")

DOS Analysis
~~~~~~~~~~~~

::

    from vise.api import dos

    # Analyze DOS from VASP output
    result = dos.analyze_dos("vasprun.xml", "OUTCAR")

    print(f"Band gap: {result.band_gap} eV")
    print(f"Fermi energy: {result.efermi} eV")

    # Save plot
    result.save_plot("dos.pdf", energy_range=(-10, 10))

    # Save data
    result.save_json("dos_data.json")

Dielectric Function Analysis
~~~~~~~~~~~~~~~~~~~~~~~~~~~~

::

    from vise.api import dielectric

    # Analyze dielectric function
    result = dielectric.analyze_dielectric("vasprun.xml", "OUTCAR")

    # Save plots for different components
    result.save_plot("absorption.pdf", plot_type="absorption_coeff")
    result.save_plot("real.pdf", plot_type="real")
    result.save_plot("imag.pdf", plot_type="imag")

    # Save data
    result.save_json("diele_func.json")
    result.save_csv("diele_func.csv")

    # Load from CSV
    loaded = dielectric.load_dielectric_from_csv("diele_func.csv")

Band Edge Properties
~~~~~~~~~~~~~~~~~~~~

::

    from vise.api import band_edge

    # Get band edge properties
    result = band_edge.get_band_edge_properties("vasprun.xml", "OUTCAR")

    if result.is_metal:
        print(f"Metallic (Fermi: {result.efermi} eV)")
    else:
        print(f"Band gap: {result.band_gap:.4f} eV")
        print(f"Type: {'direct' if result.is_direct else 'indirect'}")
        print(f"VBM: {result.vbm_info.energy:.4f} eV at {result.vbm_info.kpoint_coords}")
        print(f"CBM: {result.cbm_info.energy:.4f} eV at {result.cbm_info.kpoint_coords}")

Effective Mass Calculation
~~~~~~~~~~~~~~~~~~~~~~~~~~

Requires BoltzTrap2 to be installed.

::

    from vise.api import band_edge

    # Calculate effective mass
    result = band_edge.calculate_effective_mass(
        "vasprun.xml", "OUTCAR",
        temperature=300.0,
        concentrations=[1e18, 1e19, 1e20]
    )

    print(result)
    result.save_json("effective_mass.json")

Materials Project Integration
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Requires Materials Project API key configured in ~/.pmgrc.yaml.

::

    from vise.api import materials_project

    # Search for materials by formula
    entries = materials_project.search_materials("TiO2")
    for entry in entries[:5]:
        print(f"{entry.material_id}: {entry.space_group}, Eg={entry.band_gap:.2f} eV")

    # Get structure by Materials Project ID
    struct = materials_project.get_structure_by_id("mp-149", save_poscar=True)

    # Get most stable structure for a formula
    struct = materials_project.get_most_stable_structure("LiFePO4", save_poscar=True)

    # Get detailed material info
    info = materials_project.get_material_info("mp-149")
    print(f"Band gap: {info.band_gap} eV")
    print(f"Magnetization: {info.total_magnetization} μB")

Utility Functions
~~~~~~~~~~~~~~~~~

::

    from vise.api import util

    # Create atom POSCARs for reference calculations
    util.make_atom_poscars(["Si", "O"], output_dir="./atoms")

    # Create phonon calculation setup
    setup = util.create_phonon_setup("POSCAR", [2, 2, 2], output_dir="./phonon")
    print(f"Supercell atoms: {len(setup.supercell)}")

    # Analyze phonon results
    util.analyze_phonon("phonopy_input.json", "vasprun.xml", "phonon_band.pdf")

    # Create spin-decomposed volumetric files
    up, down = util.make_spin_decomposed_volumetric_files("CHGCAR")

    # Create lightweight volumetric data
    util.make_light_weight_volumetric_data("CHGCAR")

Legacy API (Low-level)
----------------------

For more fine-grained control, you can use the lower-level API directly.

::

    from pathlib import Path
    
    from pymatgen.core import Structure, Lattice
    
    from vise.input_set.input_options import CategorizedInputOptions
    from vise.input_set.vasp_input_files import VaspInputFiles
    from vise.input_set.task import Task
    from vise.input_set.xc import Xc
    
    structure = Structure(Lattice.cubic(1), ["Mg", "O"], [[0.0]*3, [0.5]*3])
    
    categorized_input_options = CategorizedInputOptions(
                structure=structure,
                task=Task.band,
                xc=Xc.pbe, 
                overridden_potcar={"Mg": "Mg_pv"})
    
    input_files = VaspInputFiles(categorized_input_options, overridden_incar_settings={"NSW": 20})
    input_files.create_input_files(dirname=Path("."))

The CategorizedInputOptions class constructor takes the keyword arguments that 
are arguments of 
`generate_potcar <https://github.com/kumagai-group/vise/blob/master/vise/input_set/potcar_generator.py>`_,
`IncarSettingsGenerator <https://github.com/kumagai-group/vise/blob/master/vise/input_set/incar_settings_generator.py>`_,
and `StructureKpointsGenerator <https://github.com/kumagai-group/vise/blob/master/vise/input_set/structure_kpoints_generator.py>`_,
An example is overridden_potcar shown above.

The VaspInputFiles class constructor also takes the overridden_incar_settings, which can control the INCAR tags.

Note also that the vise.yaml files are also parsed.

FireWorks Integration
---------------------

Here, we show an example of FireTask in `FireWorks <https://materialsproject.github.io/fireworks/index.html>`_.


::

    from pathlib import Path
    
    from fireworks import FiretaskBase, explicit_serialize
    from vise.input_set.input_options import CategorizedInputOptions
    from vise.input_set.vasp_input_files import VaspInputFiles
    
    @explicit_serialize
    class WriteVaspInputsTask(FiretaskBase):
    
        required_params = ["task", "xc"]
        optional_params = ["input_options", "overridden_incar_settings"]
    
        def run_task(self, fw_spec):
            categorized_input_options = CategorizedInputOptions(
                structure=fw_spec["structure"],
                task=self["task"],
                xc=self["xc"],
                **self.get("input_options", {}))
    
            input_files = VaspInputFiles(categorized_input_options,
                                         self.get("overridden_incar_settings", {}))
            input_files.create_input_files(dirname=Path("."))

API Reference
-------------

vise.api.structure
~~~~~~~~~~~~~~~~~~

.. py:function:: get_symmetry_info(structure, symprec=0.01, angle_tolerance=5.0)

   Get symmetry information for a structure.
   
   :param structure: pymatgen Structure object
   :param symprec: Length tolerance for symmetry (Å)
   :param angle_tolerance: Angle tolerance (degrees)
   :returns: SymmetryInfo dataclass

.. py:function:: get_primitive(structure, symprec=0.01, angle_tolerance=5.0)

   Get primitive cell of a structure.

.. py:function:: get_conventional(structure, symprec=0.01, angle_tolerance=5.0)

   Get conventional cell of a structure.

vise.api.vasp_inputs
~~~~~~~~~~~~~~~~~~~~

.. py:function:: create_vasp_set(structure, task="structure_opt", xc="pbe", ...)

   Create VASP input set.
   
   :param structure: pymatgen Structure
   :param task: Task name (string or Task enum)
   :param xc: XC functional (string or Xc enum)
   :param kpt_density: K-point density (Å)
   :param user_incar_settings: Dict of INCAR overrides
   :returns: VaspInputSet object

.. py:function:: get_available_tasks()

   Get list of available task types.

.. py:function:: get_available_xc()

   Get list of available XC functionals.

vise.api.band
~~~~~~~~~~~~~

.. py:function:: analyze_band(vasprun, kpoints="KPOINTS")

   Analyze band structure from VASP output.
   
   :returns: BandAnalysisResult with band_gap, vbm, cbm, is_metal

vise.api.dos
~~~~~~~~~~~~

.. py:function:: analyze_dos(vasprun, outcar="OUTCAR")

   Analyze DOS from VASP output.
   
   :returns: DosAnalysisResult with band_gap, vbm, cbm, efermi, is_metal

vise.api.dielectric
~~~~~~~~~~~~~~~~~~~

.. py:function:: analyze_dielectric(vasprun, outcar="OUTCAR", use_vasp_real=True)

   Analyze dielectric function from VASP output.
   
   :returns: DielectricAnalysisResult

.. py:function:: load_dielectric_from_csv(csv_file)

   Load dielectric data from CSV file.

vise.api.band_edge
~~~~~~~~~~~~~~~~~~

.. py:function:: get_band_edge_properties(vasprun, outcar="OUTCAR")

   Get band edge properties (VBM, CBM).
   
   :returns: BandEdgeResult

.. py:function:: calculate_effective_mass(vasprun, outcar, temperature=300.0, concentrations=None)

   Calculate effective mass using BoltzTrap2.
   
   :returns: EffectiveMassResult

vise.api.materials_project
~~~~~~~~~~~~~~~~~~~~~~~~~~

.. py:function:: search_materials(formula)

   Search Materials Project by formula.
   
   :returns: List of MaterialEntry

.. py:function:: get_structure_by_id(material_id, save_poscar=False)

   Get structure from Materials Project by ID.
   
   :returns: pymatgen Structure

.. py:function:: get_most_stable_structure(formula, save_poscar=False)

   Get most stable structure for a formula.

vise.api.util
~~~~~~~~~~~~~

.. py:function:: make_atom_poscars(elements=None, output_dir=".")

   Create POSCARs for isolated atom calculations.

.. py:function:: create_phonon_setup(unitcell, supercell_matrix, output_dir=".")

   Create phonon calculation setup.
   
   :returns: PhonopySetup

.. py:function:: analyze_phonon(phonopy_input, vasprun, output_filename)

   Analyze phonon calculation and create plot.

.. py:function:: make_spin_decomposed_volumetric_files(chgcar_file)

   Create spin-up and spin-down volumetric files.

.. py:function:: make_light_weight_volumetric_data(volumetric_file, output_filename=None)

   Create lightweight volumetric data file.
